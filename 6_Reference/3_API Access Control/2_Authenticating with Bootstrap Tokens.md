bootstrap token은 새 cluster를 생성하거나 기존 cluster에 새 no를 추가할 때 사용되는 간단한 bearer token이다. 이는 kubeadm을 지원하기 위해 만들어졌지만, 지금은 kubeadm을 사용하지 않아도 사용할 수 있다. 또한 [Kubelet TLS bootstrapping](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-tls-bootstrapping/) 시스템과 RBAC 정책을 통해 작동하도록 구축됐다.

## Bootstrap Tokens Overview
bootstrap token은 kube-system ns에 존재하는 `bootstrap.kubernetes.io/token` type secret이다. 이 secret은 kube-apiserver의 Bootstrap Authenticator가 읽는다. 만료된 tokend은 kube-controller-manager의 TokenCleaner에 의해 삭제된다. 또한 token은 BootstrapSigner controller를 통해 "discovery" 프로세스에서 사용되는 특정 cm에 대한 서명을 생성하는 데 사용된다.

## Token Format
bootstrap token은 `[a-z0-9]{6}\.[a-z0-9]{16}` 형식(예를 들어 abcdef.0123456789abcdef)을 갖는다.

첫 번째 파트는 "Token ID"로 공개 정보다. 이는 인증에 사용되는 비밀 부분을 누출시키지 않고 token을 참조할 때 사용된다. 두 번째 파트은 "Token Secret"이며 신뢰할 수 있는 당사자와만 공유되어야 한다.

## Enabling Bootstrap Token Authentication
Bootstrap Token authenticator는 kube-apiserver에 아래 flag를 사용해 활성화할 수 있다.
``` sh
--enable-bootstrap-token-auth
```

활성화되면 bootstrapping token는 kube-apiserver에 대한 인증에 bearer token을 사용할 수 있다.
```
Authorization: Bearer 07401b.f395accd246ae52d
```

token은 `system:bootstrap:<token id>` 사용자, `system:bootstrappers` 그룹으로 인증된다. 추가 그룹은 token의 Secret에 명시된다.

만료된 token을 자동 삭제하기 위해 kube-controller-manager에 아래 flag를 사용해 tokencleaner controller를 활성화한다.
``` sh
--controllers=*,tokencleaner
```

## Bootstrap Token Secret Format
유효한 token은 kube-system ns의 secret으로 존재한다. 디자인 관련된 내용은 [here](https://github.com/kubernetes/design-proposals-archive/blob/main/cluster-lifecycle/bootstrap-discovery.md)을 참고한다.

아래는 secert 예시다.
``` yaml
apiVersion: v1
kind: Secret
metadata:
  # Name MUST be of form "bootstrap-token-<token id>"
  name: bootstrap-token-07401b
  namespace: kube-system

# Type MUST be 'bootstrap.kubernetes.io/token'
type: bootstrap.kubernetes.io/token
stringData:
  # Human readable description. Optional.
  description: "The default bootstrap token generated by 'kubeadm init'."

  # Token ID and secret. Required.
  token-id: 07401b
  token-secret: f395accd246ae52d

  # Expiration. Optional.
  expiration: 2017-03-10T03:22:11Z

  # Allowed usages.
  usage-bootstrap-authentication: "true"
  usage-bootstrap-signing: "true"

  # Extra groups to authenticate the token as. Must start with "system:bootstrappers:"
  auth-extra-groups: system:bootstrappers:worker,system:bootstrappers:ingress
```

secret의 .type은 `bootstrap.kubernetes.io/token`, 이름은 `bootstrap-token-<token id>`이어야 한다. 또한 kube-system ns에 존재해야 한다.

`usage-bootstrap-*`는 이 secret이 어떤 용도로 사용될지 나타낸다. 활성화를 위해 true로 설정한다.
-  `usage-bootstrap-authentication`: 해당 토큰을 bearer token으로 kube-apiserver에 인증하는 데 사용할 수 있음을 나타낸다.
- `usage-bootstrap-signing`: 해당 토큰을 아래에 설명된대로 `cluster-info` cm에 서명하는 데 사용할 수 있음을 나타낸다.

`expiration` 필드는 token의 만료를 제어한다. 만료된 token은 인증에 사용될 때 거부되며 cm 서명 중에는 무시된다. 만료 값은 RFC3339를 사용하여 절대적인 UTC 시간으로 인코딩된다. 만료된 token을 자동으로 삭제하기 위해 kube-controller-manager의 tokencleaner controller를 활성화한다.

## Token Management with kubeadm
You can use the kubeadm tool to manage tokens on a running cluster. See the [kubeadm token docs](https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-token/) for details.

## ConfigMap Signing
token은 cm을 서명하는 데에도 사용될 수 있다. 이는 클라이언트가 kube-apiserver를 신뢰하기 전 cluster bootstrap 프로세스 초기에 사용된다. 서명된 cm은 공유한 token으로 인증할 수 있다.

cm 서명을 활성화하기 위해 kube-controller-manager의 bootstrapsigner controller를 활성화해야 한다.
``` sh
--controllers=*,bootstrapsigner
```

서명된 cm은 kube-public ns의 cluster-info다. 일반적인 흐름은 클라이언트가 인증되지 않은 상태로 이 cm을 읽고 TLS 오류를 무시한다. 그런 다음 cm에 포함된 서명을 확인하여 cm의 페이로드를 유효성 검사를 수행한다.

kubeadm의 경우 위 cm을 사용해 bootstrap에 사용된다. kubelet은 해당 cm에 인증 없이 접근해 cluster, ca 정보를 얻을 수 있다.

아래는 cluster-info cm 예시다.
``` yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-info
  namespace: kube-public
data:
  jws-kubeconfig-07401b: eyJhbGciOiJIUzI1NiIsImtpZCI6IjA3NDAxYiJ9..tYEfbo6zDNo40MQE07aZcQX2m3EB2rO3NuXtxVMYm9U
  kubeconfig: |
    apiVersion: v1
    clusters:
    - cluster:
        certificate-authority-data: <really long certificate data>
        server: https://10.138.0.2:6443
      name: ""
    contexts: []
    current-context: ""
    kind: Config
    preferences: {}
    users: []
```

cm의 kubeconfig는 cluster 정보만 채워진 설정 파일이다. 여기서 주요한 정보는 `certificate-authority-data`다. This may be expanded in the future.

서명은 "분리된(detached)" 모드를 사용하는 JWS 서명이다. 서명을 유효성 검사하려면 사용자는 kubeconfig 페이로드를 JWS 규칙에 따라 인코딩해야 한다(JWS 규칙에 따라 base64로 인코딩하면서 끝에 오는 =를 제외). 인코딩된 페이로드는 그런 다음 2 개의 점 사이에 삽입하여 전체 JWS를 형성하는 데 사용된다. 사용자는 공유 secret로 전체 token(e.g. 07401b.f395accd246ae52d)을 사용하여 HS256 체계(HMAC-SHA256)를 사용하여 JWS를 검증해야 한다. 사용자는 HS256가 사용되었는지 확인해야 한다.

> **Warning**:  
> bootstrap token을 가지고 있는 경우 token에 대한 유효한 서명을 생성할 수 있다. cm 서명을 사용할 때 여러 클라이언트와 동일한 token을 공유하는 것을 권장하지 않는다. 왜냐하면 token에 의존해 TLS 신뢰를 bootstrap하는 다른 클라이언트를 중간자 공격할 수 있는 침해된 클라이언트가 발생할 수 있기 때문이다.